<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script th:src="@{/js/script.js}" defer></script>
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <h2>Admin Panel</h2>
        <nav>
            <ul>
                <li><a href="#dashboard" class="active">Dashboard</a></li>
                <li><a href="#users">Manage Users</a></li>
                <li><a href="#products">Manage Products</a></li>
                <li><a href="#orders">Manage Orders</a></li>
                <li><a href="#reviews">View Reviews</a></li>
                <li><a href="#payments">View Payments</a></li>
                <li><a href="#categories">Manage Categories</a></li>
            </ul>
        </nav>
    </aside>
    <main class="main-content">
        <header>
            <h1>Dashboard</h1>
            <div class="user-info">
                <span>Welcome, Admin</span>
                <button id="logout">Logout</button>
            </div>
        </header>
        <section id="dashboard" class="content-section">
            <h2>Overview</h2>
            <div class="cards">
                <div class="card">
                    <h3>Total Users</h3>
                    <p id="total-users">0</p>
                </div>
                <div class="card">
                    <h3>Total Products</h3>
                    <p id="total-products">0</p>
                </div>
                <div class="card">
                    <h3>Total Orders</h3>
                    <p id="total-orders">0</p>
                </div>
            </div>
        </section>
        <section id="users" class="content-section hidden">
            <h2>Manage Users</h2>
            <button class="add-button" onclick="addUser()">Add User</button>
            <!-- The Modal -->
            <div id="userModal" class="modal" style="display: none">
                <div class="modal-content">
                    <span class="close" onclick="closeModal() ">&times;</span>
                    <h2>Register New User</h2>
                    <form action="/api/admin/users" method="post" onsubmit="return validatePasswords()">
                        <label for="firstname">First Name:</label>
                        <input type="text" id="firstname" name="firstname" placeholder="Enter First Name" required><br><br>

                        <label for="lastname">Last Name:</label>
                        <input type="text" id="lastname" name="lastname" placeholder="Enter Last Name"><br><br>

                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" placeholder="Enter Email" required><br><br>

                        <label for="password">Password:</label>
                        <input type="password" id="password" name="password" placeholder="Enter Password" required><br><br>

                        <label for="confirmPassword">Confirm Password:</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Enter Password" required><br><br>

                        <label for="phone">Phone:</label>
                        <input type="text" id="phone" name="phone" placeholder="Enter Phone Number" required><br><br>

                        <label for="address">Address:</label>
                        <input type="text" id="address" name="address" placeholder="Enter Address" required><br><br>

                        <label for="role">Role:</label>
                        <select id="role" name="role" required>
                            <option value="USER">User </option>
                            <option value="ADMIN">Admin</option>
                        </select><br><br>

                        <button type="submit">Register</button>
                    </form>
                </div>
            </div>

            <!--Edit Modal -->
            <div id="editUserModal" class="modal" style="display: none">
                <div class="modal-content">
                    <span class="close" onclick="closeEditUserModal()">&times;</span>
                    <h2>Edit User</h2>
                    <form id="editUserForm" onsubmit="submitEditUser (event)">
                        <input type="hidden" id="editUser Id" name="id">
                        <label for="editFirstname">First Name:</label>
                        <input type="text" id="editFirstname" name="firstname" placeholder="Enter First Name" required><br><br>

                        <label for="editLastname">Last Name:</label>
                        <input type="text" id="editLastname" name="lastname" placeholder="Enter Last Name"><br><br>

                        <label for="editEmail">Email:</label>
                        <input type="email" id="editEmail" name="email" placeholder="Enter Email" required><br><br>

                        <label for="editPhone">Phone:</label>
                        <input type="text" id="editPhone" name="phone" placeholder="Enter Phone Number" required><br><br>

                        <label for="editAddress">Address:</label>
                        <input type="text" id="editAddress" name="address" placeholder="Enter Address" required><br><br>

                        <label for="editRole">Role:</label>
                        <select id="editRole" name="role" required>
                            <option value="USER">User </option>
                            <option value="ADMIN">Admin</option>
                        </select><br><br>

                        <button type="submit">Update</button>
                    </form>
                </div>
            </div>

            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="users-table-body">
                <!-- Dynamic User Rows will be inserted here -->
                </tbody>
            </table>
        </section>
        <section id="products" class="content-section hidden">
            <h2>Manage Products</h2>
            <button class="add-button" onclick="addProduct()">Add Product</button>
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="products-table-body">
                <!-- Dynamic Product Rows will be inserted here -->
                </tbody>
            </table>
        </section>
        <section id="orders" class="content-section hidden">
            <h2>Manage Orders</h2>
            <table>
                <thead>
                <tr>
                    <th>Order ID</th>
                    <th>User</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="orders-table-body">
                <!-- Dynamic Order Rows will be inserted here -->
                </tbody>
            </table>
        </section>
        <section id="reviews" class="content-section hidden">
            <h2>View Reviews</h2>
            <table>
                <thead>
                <tr>
                    <th>Product</th>
                    <th>User</th>
                    <th>Rating</th>
                    <th>Comment</th>
                </tr>
                </thead>
                <tbody id="reviews-table-body">
                <!-- Dynamic Review Rows will be inserted here -->
                </tbody>
            </table>
        </section>
        <section id="payments" class="content-section hidden">
            <h2>View Payments</h2>
            <table>
                <thead>
                <tr>
                    <th>Payment ID</th>
                    <th>User</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="payments-table-body">
                <!-- Dynamic Payment Rows will be inserted here -->
                </tbody>
            </table>
        </section>
        <section id="categories" class="content-section hidden">
            <h2>Manage Categories</h2>
            <button class="add-button" onclick="addCategory()">Add Category</button>
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="categories-table-body">
                <!-- Dynamic Category Rows will be inserted here -->
                </tbody>
            </table>
        </section>
    </main>
</div>
<script>
    // Function to switch between sections
    document.querySelectorAll('.sidebar a').forEach(link => {
        link.addEventListener('click', function() {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            const targetSection = document.querySelector(this.getAttribute('href'));
            targetSection.classList.remove('hidden');
        });
    });

    // Fetch data and populate the dashboard
    async function populateDashboard() {
        const users = await fetchUsers();
        const products = await fetchProducts();
        const orders = await fetchOrders();

        document.getElementById('total-users').innerText = users.length;
        document.getElementById('total-products').innerText = products.length;
        document.getElementById('total-orders').innerText = orders.length;

        populateUsersTable(users);
        populateProductsTable(products);
        populateOrdersTable(orders);
    }

    function populateUsersTable(users) {
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';
        users.forEach(user => {
            const row = `<tr>
                <td>${user.id}</td>
                <td>${user.firstname}</td>
                <td>${user.lastname}</td>
                <td>${user.email}</td>
                <td>${user.phone}</td>
                <td>${user.address}</td>
                <td>
                    <button onclick="openEditUserModal(${user.id})">Edit</button>
                    <button onclick="deleteUser (${user.id})">Delete</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }
    async function deleteUser(user_id) {
        try {
            const response = await fetch('/addUser ', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // Sending JSON
                },
                body: JSON.stringify(user) // Convert JavaScript object to JSON
            });

            if (response.ok) {
                alert("User  registered successfully!");
                closeModal(); // Close the modal
                // Optionally, you may want to refresh the user list or take other actions
            } else {
                alert("Failed to register user. Please try again.");
            }
        } catch (error) {
            console.error('Error:', error);
            alert("An error occurred while registering the user.");
        }
    }


    function populateProductsTable(products) {
        const tbody = document.getElementById('products-table-body');
        tbody.innerHTML = '';
        products.forEach(product => {
            const row = `<tr>
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>$${product.price.toFixed(2)}</td>
                <td>
                    <button onclick="editProduct(${product.id})">Edit</button>
                    <button onclick="deleteProduct(${product.id})">Delete</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function populateOrdersTable(orders) {
        const tbody = document.getElementById('orders-table-body');
        tbody.innerHTML = '';
        orders.forEach(order => {
            const row = `<tr>
                <td>${order.id}</td>
                <td>${order.user.name}</td>
                <td>$${order.total.toFixed(2)}</td>
                <td>${order.status}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }
    function validatePasswords() {
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        if (password !== confirmPassword) {
            alert("Passwords do not match!");
            return false;
        }
        return true;
    }

    function addUser () {
        // Show the modal
        document.getElementById("userModal").style.display = "block";
    }

    function closeModal() {
        // Hide the modal
        document.getElementById("userModal").style.display = "none";
    }

    window.onclick = function(event) {
        const modal = document.getElementById("userModal");
        if (event.target === modal) {
            closeModal();
        }
    }

    async function submitUserForm(event) {
        event.preventDefault(); // Prevent the default form submission

        if (!validatePasswords()) {
            return; // Stop if passwords do not match
        }

        // Gather form data
        const user = {
            firstname: document.getElementById("firstname").value,
            lastname: document.getElementById("lastname").value,
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
            phone: document.getElementById("phone").value,
            address: document.getElementById("address").value,
            role: document.getElementById("role").value
        };

        try {
            const response = await fetch('/addUser ', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // Sending JSON
                },
                body: JSON.stringify(user) // Convert JavaScript object to JSON
            });

            if (response.ok) {
                alert("User  registered successfully!");
                closeModal(); // Close the modal
                // Optionally, you may want to refresh the user list or take other actions
            } else {
                alert("Failed to register user. Please try again.");
            }
        } catch (error) {
            console.error('Error:', error);
            alert("An error occurred while registering the user.");
        }
    }

    function fetchUserById(id) {
        // Replace this with your actual API call or data retrieval logic.
        const users = fetchUsers();

        return users.find(user => user.id === id);
    }

    function openEditUserModal(userId) {
        document.getElementById("editUserModal").style.display = "block";
        // Fetch user data and populate the edit form
        const user = fetchUserById(userId); // Assume this function fetches user data
        document.getElementById("editUserId").value = user.id;
        document.getElementById("editFirstname").value = user.firstname;
        document.getElementById("editLastname").value = user.lastname;
        document.getElementById("editEmail").value = user.email;
        document.getElementById("editPhone").value = user.phone;
        document.getElementById("editAddress").value = user.address;
        document.getElementById("editRole").value = user.role;
        document.getElementById("editUserModal").style.display = "block"; // Show the edit modal
    }

    function closeEditUserModal() {
        document.getElementById("editUserModal").style.display = "none"; // Hide the edit modal
    }

    async function submitEditUser (event) {
        event.preventDefault(); // Prevent the default form submission

        const userId = document.getElementById("editUserId").value;
        const updatedUser  = {
            id: userId,
            firstname: document.getElementById("editFirstname").value,
            lastname: document.getElementById("editLastname").value,
            email: document.getElementById("editEmail").value,
            phone: document.getElementById("editPhone").value,
            address: document.getElementById("editAddress").value,
            role: document.getElementById("editRole").value
        };

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json' // Sending JSON
                },
                body: JSON.stringify(updatedUser) // Convert JavaScript object to JSON
            });

            if (response.ok) {
                alert("User  updated successfully!");
                closeEditUserModal(); // Close the edit modal
                populateDashboard(); // Refresh the user list
            } else {
                alert("Failed to update user. Please try again.");
            }
        } catch (error) {
            console.error('Error:', error);
            alert("An error occurred while updating the user.");
        }
    }

    // Call the function to populate the dashboard on page load
    window.onload = populateDashboard;
</script>
</body>
</html>